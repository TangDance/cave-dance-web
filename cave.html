<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Cave Dance | Cave 220 | CAMLab </title>
		<meta content="Dunhuang Cave Dance" name="description" />
		<meta content="Dunhuang Cave Dance" property="og:title" />
		<meta content="Dunhuang Cave Dance" property="og:description" />
		<meta property="og:type" content="website" />
		<meta content="width=device-width, initial-scale=1" name="viewport" />
		<link href="assets/img/favicon.png" rel="shortcut icon" type="image/x-icon" />
		<link href="assets/img/favicon.png" rel="apple-touch-icon" />
		<meta
			name="viewport"
			content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
		/>
		<link type="text/css" rel="stylesheet" href="main.css" />

		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"
			type="text/javascript"
		></script>
		<script
			src="https://cdn.jsdelivr.net/npm/fflate@0.7.2/umd/index.min.js"
			type="text/javascript"
		></script>
		<script
			src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=603fe89ec4bbcece7ee6a53a"
			type="text/javascript"
			integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			crossorigin="anonymous"
		></script>
		<link href="cave.css" rel="stylesheet" type="text/css" />
		<style>
			#blocker {
				position: absolute;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
			}

			#instructions {
				width: 100%;
				height: 100%;

				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;

				text-align: center;
				font-size: 14px;
				cursor: pointer;
			}
		</style>
	</head>

	<body>

		<div class="mobile">
			<video class="video-cave" width="100%" height="100%" controls>
				<source src="movie.mp4" type="video/mp4">
			</video>
		</div>

		<div class="desktop">
			<div id="loading" class="loading">
				<div class="wait">
					<div class="wait-inner">
						<div class="wait_img-wrap">
							<div
								data-w-id="e8311aee-d434-6a91-e883-eae45438144d"
								class="wait_img"
							></div>
							<div
								data-w-id="a5f9b580-a290-06a9-c3a9-042380199875"
								class="wait-overlay"
							></div>
						</div>
						<div class="wait-content">
							<div class="hero-h1__wrap">
								<img
									src="https://chunweb.files.wordpress.com/2022/04/cave220.png"
									loading="lazy"
									alt=""
									class="hero-h1"
								/>
							</div>
						</div>
						<div id="menu" style="opacity: 0.8">
							<div class="container" >
								<div class="title-container">
									<div class="title">
										<h1>莫高窟第220窟</h1>
										<h2>Mogao Cave 220</h2>
										<div id="loading-title" class="loading">
											Loading...
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div id="blocker">
				<div id="instructions">
					<div id="menu" style="opacity: 0.6">
						<div class="container">
							<div class="title-container">
								<div class="title">
									<h1>莫高窟第220窟</h1>
									<h2>Mogao Cave 220</h2>
								</div>
									<p>
										Move: WASD<br />
										Look: MOUSE
									</p>
									<button class="explore">Click to Explore</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="tour">
				<div class="mainline">莫高窟第220窟</div>
				<div class="subline">Mogao Cave 220</div>

				<!-- <div class="buttonlines">
					<div class="buttonline">
						<div
							class="scene_start"
							id="scene1_start"
							style="display: inline-block; vertical-align: middle;"
						>
							<button class="menu continue">
								继续
								<svg
									width="24"
									height="24"
									xmlns="http://www.w3.org/2000/svg"
									fill-rule="evenodd"
									clip-rule="evenodd"
								>
									<path
										d="M21.883 12l-7.527 6.235.644.765 9-7.521-9-7.479-.645.764 7.529 6.236h-21.884v1h21.883z"
									/>
								</svg>
							</button>
						</div>
						<div style="display: inline-block; vertical-align: middle;">
							<button class="menu" id="button_scene1">主室北壁</button>
						</div>
					</div>

					<div class="buttonline">
						<div
							class="scene_start"
							id="scene2_start"
							style="display: inline-block; vertical-align: middle;"
						>
							<button class="menu continue">
								继续
								<svg
									width="24"
									height="24"
									xmlns="http://www.w3.org/2000/svg"
									fill-rule="evenodd"
									clip-rule="evenodd"
								>
									<path
										d="M21.883 12l-7.527 6.235.644.765 9-7.521-9-7.479-.645.764 7.529 6.236h-21.884v1h21.883z"
									/>
								</svg>
							</button>
						</div>
						<button class="menu" id="button_scene2">主室南壁</button>
					</div>

					<div class="buttonline">
						<div class="animation-circle-container scene_start" style="opacity:0">
							<div class="circle"></div>
							<div class="circle2"></div>
							<div class="logo-div-send"></div>
						</div>
						<button class="menu" id="button_reset">重新开始</button>
					</div>
				</div>
			</div> -->
		</div>




		<!-- Import maps polyfill -->
		<!-- Remove this when import maps will be widely supported -->
		<script
			async
			src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
		></script>

		<script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js"
				}
			}
		</script>

		<script type="module">
			import * as THREE from "three";
			import { GLTFLoader } from "./jsm/loaders/GLTFLoader.js";
			import { PointerLockControls } from "./jsm/controls/PointerLockControls.js";
			import { RoomEnvironment } from "./jsm/environments/RoomEnvironment.js";
			import { GUI } from "./jsm/libs/lil-gui.module.min.js";

			let camera, scene, renderer, controls;

			const caveScale = 0.01;

			const objects = [];

			let raycaster;

			let moveForward = false;
			let moveBackward = false;
			let moveLeft = false;
			let moveRight = false;
			let canJump = false;

			let prevTime = performance.now();
			const velocity = new THREE.Vector3();
			const direction = new THREE.Vector3();
			const vertex = new THREE.Vector3();
			const color = new THREE.Color();

			// HTML elements
			const explore = $(".explore");
			const scene1 = $("#button_scene1");
			const scene2 = $("#button_scene2");
			const reset = $("#button_reset");

			// GUI params setup
			const params = {
				camX: 5.82,
				camY: 10,
				camZ: 3.36,
				speedDelta: 8000,
				xMax: 7.82,
				xMin: 3.82,
				zMax: 1.46,
				zMin: -65
			};

			let speedDelta = params.speedDelta;
			let xMax = params.xMax;
			let xMin = params.xMin;
			let zMax = params.zMax;
			let zMin = params.zMin;

			init();
			animate();



			function setupGUI() {
				const gui = new GUI();

				gui.add(params, "camX", -10, 10).onChange(function() {
					setCameraPosition();
				});
				gui.add(params, "camY", -10, 10).onChange(function() {
					setCameraPosition();
				});
				gui.add(params, "camZ", -10, 10).onChange(function() {
					setCameraPosition();
				});

				gui.add(params, "speedDelta", 2000, 10000).onChange(function() {
					speedDelta = params.speedDelta;
				});

				gui.add(params, "xMax", 5, 20).onChange(function() {
					xMax = params.xMax;
				});
				gui.add(params, "xMin", -20, 5).onChange(function() {
					xMin = params.xMin;
				});
				gui.add(params, "zMax", 1, 5).onChange(function() {
					zMax = params.zMax;
				});
				gui.add(params, "zMin", -200, 5).onChange(function() {
					zMin = params.zMin;
				});

				gui.open();
			}

			function init() {
				const container = document.createElement("div");
				document.body.appendChild(container);

				// set up camera
				camera = new THREE.PerspectiveCamera(
					75,
					window.innerWidth / window.innerHeight,
					1,
					1000
				);
				setCameraPosition();

				// GUI setup:
				//setupGUI();

				scene = new THREE.Scene();
				scene.background = new THREE.Color(0xffffff);
				// model

				// load model: cave
				const loader = new GLTFLoader()
					.setPath("models/dunhuang/Cave220_GLTF/")
					.load("model.gltf", function(gltf) {
						gltf.scene.traverse(e => {
							if (e.type === "Mesh") {
								if (e.material) {
									e.material.side = THREE.FrontSide;
								}
							}
						});
						gltf.scene.scale.set(caveScale, caveScale, caveScale);
						scene.add(gltf.scene);
						renderer.render(scene, camera);
						TweenMax.to("#loading", 1, { opacity: 0, display: "none" });
						TweenMax.to(".container", 2, { opacity: 1 });
						//TweenMax.to(".title", 4, {opacity:1});
						TweenMax.to(".explore", 5, { opacity: 1 });
						TweenMax.to("#loading-title", 0.5, { opacity: 0, display: "none" });
					});

				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.toneMapping = THREE.ACESFilmicToneMapping;
				renderer.toneMappingExposure = 1;
				renderer.outputEncoding = THREE.sRGBEncoding;
				container.appendChild(renderer.domElement);

				// --- environment ---
				const environment = new RoomEnvironment();
				const pmremGenerator = new THREE.PMREMGenerator(renderer);

				scene.background = new THREE.Color(0x000000);
				scene.environment = pmremGenerator.fromScene(environment).texture;

				window.addEventListener("resize", onWindowResize);

				// --- Lights ---

				//  (HemisphereLight not helping much)
				const light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
				light.position.set(0.5, 1, 0.75);
				scene.add(light);

				// ROOM LIGHT: PointLight: 2rd param
				const pointLight = new THREE.PointLight(0xffffff, .5);
				pointLight.position.set(0, 0, 0);
				camera.add(pointLight);


				// --- PointerLockControls

				controls = new PointerLockControls(camera, document.body);

				const blocker = document.getElementById("blocker");
				//blocker.style.display = "none";  // blocker set to invisible at beginner
				const instructions = document.getElementById("instructions");

				instructions.addEventListener("click", function() {
					controls.lock();
				});

				controls.addEventListener("lock", function() {
					instructions.style.display = "none";
					blocker.style.display = "none";
				});

				controls.addEventListener("unlock", function() {
					blocker.style.display = "block";
					instructions.style.display = "";
				});

				// TODO: addEventListener, press certain key -> controls.unlock()

				scene.add(controls.getObject());

				const onKeyDown = function(event) {
					switch (event.code) {
						case "ArrowUp":
						case "KeyW":
							moveForward = true;
							break;

						case "ArrowLeft":
						case "KeyA":
							moveLeft = true;
							break;

						case "ArrowDown":
						case "KeyS":
							moveBackward = true;
							break;

						case "ArrowRight":
						case "KeyD":
							moveRight = true;
							break;

					}
				};

				const onKeyUp = function(event) {
					switch (event.code) {
						case "ArrowUp":
						case "KeyW":
							moveForward = false;
							break;

						case "ArrowLeft":
						case "KeyA":
							moveLeft = false;
							break;

						case "ArrowDown":
						case "KeyS":
							moveBackward = false;
							break;

						case "ArrowRight":
						case "KeyD":
							moveRight = false;
							break;
					}
				};

				document.addEventListener("keydown", onKeyDown);
				document.addEventListener("keyup", onKeyUp);

				raycaster = new THREE.Raycaster(
					new THREE.Vector3(),
					new THREE.Vector3(0, -1, 0),
					0,
					10
				);
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(window.innerWidth, window.innerHeight);
			}


			function animate() {
				requestAnimationFrame(animate);

				const time = performance.now();

				if (controls.isLocked === true) {
					raycaster.ray.origin.copy(controls.getObject().position);
					raycaster.ray.origin.y -= 10;

					const intersections = raycaster.intersectObjects(objects, false);

					const onObject = intersections.length > 0;

					const delta = (time - prevTime) / speedDelta;

					velocity.x -= velocity.x * 10.0 * delta;
					velocity.z -= velocity.z * 10.0 * delta;

					velocity.y -= 9.8 * 100.0 * delta; // 100.0 = mass

					direction.z = Number(moveForward) - Number(moveBackward);
					direction.x = Number(moveRight) - Number(moveLeft);
					direction.normalize(); // this ensures consistent movements in all directions

					if (moveForward || moveBackward)
						velocity.z -= direction.z * 400.0 * delta;
					if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

					if (onObject === true) {
						velocity.y = Math.max(0, velocity.y);
						canJump = true;
					}

					controls.moveRight(-velocity.x * delta);
					controls.moveForward(-velocity.z * delta);

					controls.getObject().position.y += velocity.y * delta; // new behavior

					if (controls.getObject().position.y < 10) {
						velocity.y = 0;
						controls.getObject().position.y = 10;

						canJump = true;
					}

					// Apply area limitation on controls
					if (controls.getObject().position.x > xMax) {
						velocity.x = 0;
						controls.getObject().position.x = xMax;
					}
					if (controls.getObject().position.x < xMin) {
						velocity.x = 0;
						controls.getObject().position.x = xMin;
					}

					if (controls.getObject().position.z > zMax) {
						velocity.z = 0;
						controls.getObject().position.z = zMax;
					}
					if (controls.getObject().position.z < zMin) {
						velocity.z = 0;
						controls.getObject().position.z = zMin;
					}
				}

				prevTime = time;

				renderer.render(scene, camera);
			}

			function setCameraPosition() {
				camera.position.set(params.camX, params.camY, params.camZ);
			}

			function setEventListeners() {

				explore.click(() => {
					if (!gsap.isTweening(camera.position)) {
						gsap.to(camera.position, {
							duration: 5,
							z: -15,
							ease: "power3.inOut",
							onComplete: () => {
								console.log("onComplete explore gsap");
							}
						});
					}
					TweenMax.to(".explore", 0.1, { opacity: 0, display: "none" });
					TweenMax.to(".tour", 2, { opacity: 1 });
				});

				scene1.click(() => {
					clearTour();
					if (!gsap.isTweening(camera.position)) {
						let cave = CAMERA_POSITIONS["cave_center"];
						gsap
							.timeline()
							.to(camera.position, {
								x: cave.x,
								y: cave.y,
								z: cave.z,
								onComplete: () => {
									camera.rotation.x = 0;
									camera.rotation.y = 0;
								}
							})
							.to(camera.position, {
								x: -70,
								onComplete: () => {
									const startY = camera.rotation.y;
									gsap.to(camera.rotation, {
										duration: 4,
										y: startY - 24 * settings.walkerTurnSpeed
									});
									$("#button_scene1").addClass("active");
									$("#scene1_start").animate(
										{
											opacity: 1
										},
										1000,
										function() {}
									);
								}
							});
					}
				});
			}

			function clearTour() {
			$("#button_scene1").removeClass("active");
			$("#button_scene2").removeClass("active");

			$("#scene1_start").animate({ opacity: 0 }, 30);
			$("#scene2_start").animate({ opacity: 0 }, 30);
		}


			setEventListeners()
		</script>
	</body>
</html>
