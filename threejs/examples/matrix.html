<head>
	<title>Cave Dance | CAMLab </title>
	<meta content="Dunhuang Cave Dance" name="description" />
	<meta content="Dunhuang Cave Dance" property="og:title" />
	<meta content="Dunhuang Cave Dance" property="og:description" />
	<meta property="og:type" content="website" />
	<meta content="width=device-width, initial-scale=1" name="viewport" />
	<meta charset="utf-8">
	<link href="https://assets-global.website-files.com/603fe89ec4bbcece7ee6a53a/61014076aa014a767ce9208c_favicon.png" rel="shortcut icon" type="image/x-icon" />
	<link href="https://assets-global.website-files.com/603fe89ec4bbcece7ee6a53a/610140795b9a3f0382a58e51_web-clip.png" rel="apple-touch-icon" />
	<script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=603fe89ec4bbcece7ee6a53a" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<style>
		body {
        margin: 0;
				overflow: hidden;
    }

		#menu {
		  position: absolute;
			top: 2vw;
		  right: 2vw;
		  width: 100%;
		  text-align: right;
			text-shadow: 0 0 10px rgb(189 216 216 / 95%);
		  color: rgba(255, 255, 255, 0.75);
			font-family: Metropolis, sans-serif;
			font-style: italic;
		}

		#menu .info {
			line-height: 1.3;
			margin-bottom:1vw;
			font-size: 1.5vw;
		}

		#menu .info .subline {
			font-size: 1.1vw;
		}

		#menu button.active {
			background-color: rgba(255, 255, 255, 0.1);
			font-weight: bold;
			box-shadow: 0 0 10px rgb(189 216 216 / 95%);
		}

		#menu button {
		  background: transparent;
		  outline: 1px solid rgba(255, 255, 255, 0.75);
		  border: 0px;
		  padding: 5px 10px;
		  cursor: pointer;
			font-size: 0.6rem;
			color: #9a9a9a; /*#bbb9b9;*/
    	border: solid 1px var(--focus-color);
    	padding: 1px 6px;
			line-height: 1.2;
		}

		#menu button:hover {
		  background-color: rgba(255, 255, 255, 0.2);
		}

		#menu .buttonline {
			margin-top: 0.2rem;
		}

		video {
			display : none;
		}

    </style>
</head>

<body>

	<div id="menu">
		<div class="info">
			<div>Key Poses In Dunhuang Celestial Dance</div>
			<div class="subline">36 SAMPLES</div>
		</div>

		<div class="buttonline">
			<button class="menu active" id="button_fire">FIRE</button>
			<button class="menu" id="button_water">WATER</button>
			<button class="menu" id="button_spin_particles">PARTICLES</button>
			<!-- <button class="menu" id="button_gold_lines">LINES</button> -->
			<button class="menu" id="button_spin_strips">STRIPS</button>
			<button class="menu" id="button_mocap">MOCAP</button>
		</div>


				<div class="buttonline">
					<button class="menu" id="button_reset">RESET</button>
				</div>
	</div>

  <script type="importmap">
		{
      "imports": {
        "three": "../build/three.module.js"
      }
    }
  </script>

	<script type="module">
    import * as THREE from 'three';
		import { OrbitControls } from '//cdn.skypack.dev/three@0.136/examples/jsm/controls/OrbitControls.js';
    import { Reflector } from '//cdn.skypack.dev/three@0.136/examples/jsm/objects/Reflector.js';

		const VIDEO_SOURCES = {
			'fire': ["textures/dunhuang/SKELETON/ChineseDance_Particle_Fire.mp4", "textures/dunhuang/SKELETON/ChineseDance_Particle_Water.mp4"],
			'water': ["textures/dunhuang/SKELETON/ChineseDance_Particle_Water.mp4"],
			'spin_particles': ["textures/dunhuang/SKELETON/Spin_Particles.mp4"],
			'gold_lines': ["textures/dunhuang/SKELETON/DanceTurn_Lines_Gold_Fast.mp4"],
			'spin_strips': ["textures/dunhuang/SKELETON/Spin_Strips.mp4"],
			'mocap': []
		};

		for (let i=1; i<3;i++) {
			VIDEO_SOURCES.mocap.push("textures/dunhuang/OF/36pose-male-0" + i + "-front.mov");
		}

    const Settings = function() {
			this.currentVideo = 'fire';
			this.cameraX = 0;
			this.cameraY = 0;
			this.cameraZ = -30;
			this.groundWidth = 2000;
			this.groundHeight = 2000;
			this.showGridHelper = false;
			this.numVideoClonesX = 3;
			this.numVideoClonesZ = 6;
			this.videoSpacingX = 18;
			this.videoSpacingZ = 10;
			this.videoWidth = 12; //original video aspect ratio is 16
			this.videoHeight = 16;
			this.videoDepth = 0.001;
			this.videoOpacity = 0.3;
    };
    const settings = new Settings();

		let camera;
		let canvas; // dom element the renderer renders to
		let textures = [];
		let videoIdsActive = [];
		let videoDOMs = [];
		let objects = [];


		function createVideoSrcDOMs() {
			const videoSources = VIDEO_SOURCES[settings.currentVideo];
			console.log(settings.currentVideo, videoSources.length);

			videoSources.forEach((videoSrc, i) => {
				const video = document.createElement('video');
				video.id = 'video_' + settings.currentVideo + "_" + i;
				video.src = videoSrc;
				video.autoplay = true;
				video.muted = true;
				video.loop = true;
				video.playsinline = true;
				video.crossOrigin = 'anonymous';
				videoDOMs.push(video);
				console.log(video);
				document.body.appendChild(video);
			});
		}

		function init() {
			if (canvas) {
				canvas.remove();
			}

			createVideoSrcDOMs();

			const renderer = new THREE.WebGLRenderer();

			renderer.setSize(window.innerWidth, window.innerHeight);

			canvas = renderer.domElement;

			document.body.appendChild(renderer.domElement);

			const scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera(
					45,
					window.innerWidth / window.innerHeight,
					0.1,
					1000
			);

			const orbit = new OrbitControls(camera, renderer.domElement);

			camera.position.set(settings.cameraX, settings.cameraY, settings.cameraZ);

			orbit.update();

			const groundGeometry = new THREE.PlaneGeometry(settings.groundWidth, settings.groundHeight);

			const planeMesh = new THREE.Mesh( groundGeometry,
					new THREE.MeshBasicMaterial({
							side: THREE.DoubleSide,
							visible: false
					})
			);
			planeMesh.rotateX(-Math.PI / 2);
			scene.add(planeMesh);
			planeMesh.name = 'ground';

			const groundMirror = new Reflector( groundGeometry, {
				clipBias: 0.001, //0.003
				textureWidth: window.innerWidth * window.devicePixelRatio,
				textureHeight: window.innerHeight * window.devicePixelRatio,
				color: 0x777777
			} );
			groundMirror.position.y = -settings.videoHeight / 2;
			groundMirror.rotateX( - Math.PI / 2 );
			scene.add( groundMirror );
			groundMirror.name = 'groundMirror';


			const skyMirror = new Reflector( groundGeometry, {
				clipBias: 0.003,
				textureWidth: window.innerWidth * window.devicePixelRatio,
				textureHeight: window.innerHeight * window.devicePixelRatio,
				color: 0x777777
			} );
			skyMirror.position.x = -20;
			skyMirror.position.y = settings.videoHeight / 2;
			skyMirror.rotateX( Math.PI / 2 );
			scene.add( skyMirror );
			skyMirror.name = 'skyMirror';

			if (settings.showGridHelper) {
				const grid = new THREE.GridHelper(settings.groundWidth, settings.groundHeight);
				scene.add(grid);
			}


			function createVideoMesh(videoId) {
				const video = document.getElementById( videoId );
				video.play(); // this is the key to play video
				const texture = new THREE.VideoTexture( video );
				texture.minFilter = THREE.LinearFilter;
				texture.magFilter = THREE.LinearFilter;
				texture.repeat.set(0.5, 1); // this scales the video
				const geometry = new THREE.BoxGeometry(settings.videoWidth, settings.videoHeight, settings.videoDepth);
				const material = new THREE.MeshBasicMaterial({
					map: texture,
					side: THREE.FrontSide,
					toneMapped: false,
					transparent: true,
					opacity: settings.videoOpacity
				});

				if (videoIdsActive.indexOf(videoId) === -1) {
					videoIdsActive.push(videoId);
					textures.push(texture);
				}

				return new THREE.Mesh(geometry, material);
			}


			function createVideoMeshAt(x, y, z, meshToClone) {
				const videoIdx = 0;
				let meshClone = meshToClone ? meshToClone.clone() : createVideoMesh('video_' + settings.currentVideo + '_' + videoIdx);
				meshClone.position.set(x, y, z);
				scene.add(meshClone);
				objects.push(meshClone);
			}

		//	const mesh = createVideoMesh('video_' + settings.currentVideo + "_" + 0);

			// FIRST ROW
			for (var i = 0 ; i < settings.numVideoClonesX; i++) {
				createVideoMeshAt(i*settings.videoSpacingX, 0, 0);
			}

			for (var i = 0 ; i < settings.numVideoClonesX; i++) {
				createVideoMeshAt(-i*settings.videoSpacingX, 0, 0);
			}


			//

			for (var i = 0 ; i < settings.numVideoClonesZ; i++) {
				createVideoMeshAt(0, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(settings.videoSpacingX, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(-settings.videoSpacingX, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(settings.videoSpacingX*settings.numVideoClonesX, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(-settings.videoSpacingX*settings.numVideoClonesX, 0, i*settings.videoSpacingZ);
			}

			// const mousePosition = new THREE.Vector2();

			function animate(time) {
				textures.forEach((texture, i) => {
						texture.needsUpdate = true; // this is the key to play the video
				});
				renderer.render(scene, camera);
			}

			renderer.setAnimationLoop(animate);
		}

		init();


		function onButtonClick(clickEvent) {
				$('#button_' + settings.currentVideo).removeClass( "active" );
				const buttonId = clickEvent.target.id;
				$('#'+buttonId).addClass( "active" );
				const currentVideo = buttonId.split("button_")[1];
				settings.currentVideo = currentVideo;

				videoIdsActive = [];
				textures = [];
				objects = [];

				videoDOMs.forEach(videoDOM => videoDOM.remove());
				videoDOMs = [];
				init();
		}

		$('#button_reset').click(  function () {
			camera.position.set(settings.cameraX, settings.cameraY, settings.cameraZ);
			camera.lookAt(0,0,0);
		} );

		$('#button_fire').click(  function () {
			onButtonClick(event);
		} );

		$('#button_water').click(  function () {
			onButtonClick(event);
		} );

		$('#button_spin_particles').click(  function () {
			onButtonClick(event);
		} );

		// $('#button_gold_lines').click(  function () {
		// 	onButtonClick(event);
		// } );

		$('#button_spin_strips').click(  function () {
			onButtonClick(event);
		} );

		$('#button_mocap').click(  function () {
			onButtonClick(event);
		} );

		window.addEventListener('resize', function() {
		    camera.aspect = window.innerWidth / window.innerHeight;
		    camera.updateProjectionMatrix();
		    renderer.setSize(window.innerWidth, window.innerHeight);
		});


  </script>
</body>
