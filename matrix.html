<head>
	<title>Cave Dance | CAMLab </title>
	<meta content="Dunhuang Cave Dance" name="description" />
	<meta content="Dunhuang Cave Dance" property="og:title" />
	<meta content="Dunhuang Cave Dance" property="og:description" />
	<meta property="og:type" content="website" />
	<meta content="width=device-width, initial-scale=1" name="viewport" />
	<meta charset="utf-8">
	<link href="assets/img/favicon.png" rel="shortcut icon" type="image/x-icon" />
	<link href="assets/img/favicon.png" rel="apple-touch-icon" />
	<script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=603fe89ec4bbcece7ee6a53a" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<link href="base.css" rel="stylesheet" type="text/css" />

	<style>
		body {
        margin: 0;
				overflow: hidden;
				background: black;
    }
		#menu {
		  position: absolute;
			top: 2.5vw;
		  right: 2vw;
		  text-align: right;
			text-shadow: 0 0 10px rgb(189 216 216 / 95%);
		  color: rgba(255, 255, 255, 0.75);
		}

		#menu .info {
			line-height: 1.3;
			margin-bottom:1vw;
			font-size: 1.5vw;
		}

		#menu .info .subline {
			font-size: 1.1vw;
		}

		#menu button.active {
			/* background-color: rgba(255, 255, 255, 0.1); */
			font-weight: bold;
			/* box-shadow: 0 0 10px rgb(189 216 216 / 95%); */
		}

		#menu button {
			background: transparent;
			outline: 1px solid rgba(255, 255, 255, 0.75);
			cursor: pointer;
			color: #9a9a9a;
			border: solid 1px var(--focus-color);
			padding: 0.2vw 0.5vw 0.1vw;
			margin: 0.2vw;
			font-size: 0.9vw;
			line-height: 1.2;
		}

		#menu button:hover {
		  background-color: rgba(255, 255, 255, 0.1);
		}

		#menu .buttonline {
			opacity: 0.8;
			margin-top: 0.2rem;
		}

		video {
			display : none;
		}

    </style>
</head>

<body>
	<div data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b994" class="navbar" style="padding:1rem 0.5vw 0 2.5vw ">
		<div class="n-block left">
			<div data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b996" class="n-wrap">
				<div data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b997" class="n-trigger menu-trigger">
					<div data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b998" class="n-line"></div>
					<div data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b999" class="n-line bottom"></div>
				</div>
			</div>

			<!-- Site Navigation Menu -->
			<div class="menu">
			  <div data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99b" class="m-inner">
			    <a class="title-row" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99c" href="index.html" class="m-link w-inline-block">
			      <span  data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99d" >
			        <img src="assets/img/nodes.png" loading="eager"/>
			        <h2 class="h-h2 menu-li title linkable">Cave Dance</h2>
			        <!--
			        <img src="assets/img/active_item.png" class="menu-li-active-img" loading="eager"/>
			        -->
			      </span>
			    </a>

			    <link rel="prefetch" href="home.html" />
			    <a aria-label="Theater" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99f" href="home.html" class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a0" class="h-h2 menu-li bold">Theater</h2>
			    </a>

			    <div class="menu-li-border"></div>

			    <a aria-label="Academic" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99f"  class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a0" class="h-h2 menu-li bold">Academic</h2>
			    </a>

			    <link rel="prefetch" href="cave.html" />
			    <a aria-label="Cave 220" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99f" href="cave.html" class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a0" class="h-h2 menu-li linkable thin">Cave 220</h2>
			    </a>

			    <div class="menu-li-border"></div>

			    <a aria-label="Experiments" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99f" class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a0" class="h-h2 menu-li bold">Experiments</h2>
			    </a>

			    <a aria-label="Reconstructing Celestial Dance" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99f" href="methods.html" class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a0" class="h-h2 menu-li linkable thin">Reconstructing Celestial Dance</h2>
			    </a>

			    <a aria-label="Visualizing Celestial Body" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99f" href="matrix.html" class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a0" class="h-h2 menu-li active linkable thin">Visualizing Celestial Body</h2>
						<img src="assets/img/active_item.png" class="menu-li-active-img" loading="eager"/>
			    </a>

			    <div class="menu-li-border"></div>

			    <link rel="prerender" href="education.html" />
			    <a aria-label="Education" draggable="false" rel="noopener" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a2" href="education.html" class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a3" class="h-h2 menu-li linkable bold">Education</h2>
			    </a>

			    <div class="menu-li-border"></div>

			    <link rel="prefetch" href="events.html" />
			    <a aria-label="Events" rel="noopener" draggable="false" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b99f" href="events.html" class="m-link w-inline-block">
			      <h2 data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a0" class="h-h2 menu-li linkable bold">Events</h2>
			    </a>

			  </div>
			  <div class="menu-content">
			    <div class="menu-mask"><img src="https://chunweb.files.wordpress.com/2022/03/amo1.png" loading="eager" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a7" alt="" class="menu-img" /><img src="https://chunweb.files.wordpress.com/2022/03/amo3.png"
			        loading="eager" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a8" alt="" class="menu-img" />
			      <img src="https://chunweb.files.wordpress.com/2022/03/amo2.png" loading="eager" data-w-id="2264dfe2-412c-a750-b778-fffb7eb6b9a9" alt="" class="menu-img" /></div>
			  </div>

			  <!-- <div class="m-footer">
			    <div class="footer">
			      <div class="f-row">
			        <div class="f-col left">
			          <div class="f-link"><a aria-label="privacy" rel="noopener" draggable="false" href="#" class="h-h4 disclaimer bold">Team</a></div>
			          <div class="f-link last"><a aria-label="privacy" rel="noopener" draggable="false" href="#" class="h-h4 disclaimer bold">Returns</a></div>
			        </div>
			        <div class="f-col center">
			          <div class="h-h4 disclaimer bold">Â©2022 Harvard CAMLab</div>
			        </div>
			        <div class="f-col right">
			          <div class="h-h4 disclaimer bold"><a href="https://camlab.fas.harvard.edu/About" aria-label="Contact" rel="noopener" draggable="false" class="link underline">Contact Us</a></div>
			        </div>
			      </div>
			    </div>
			  </div> -->

			  <div class="m-bg"></div>
			  <div data-animation="cursor" rel="noopener" data-w-id="94bf8e40-acca-479f-14ca-8485acd952d1" class="cta-wrap close">
			    <div class="cta-bg"></div>
			    <div class="cta-img menu-close"><img src="assets/img/close.svg" loading="lazy" alt="" class="img ico" /></div>
			    <div class="cta-back">
			      <div class="cta-inner"></div>
			    </div>
			  </div>
			</div>


	</div>

	<main data-template="home" class="content demo">

		<script src="./composition_master.js" type="text/javascript"></script>

		<div id="menu">
			<div class="info">
				<div>Key Poses In Dunhuang Celestial Dance</div>
				<div class="subline">36 SAMPLES</div>
			</div>

			<div class="buttonline">
				<button class="active" id="button_fire">FIRE</button>
				<button id="button_water">WATER</button>
				<button id="button_spin_particles">PARTICLES</button>
				<button id="button_spin_strips">STRIPS</button>
				<button id="button_mocap">MOCAP</button>
			</div>

			<div class="buttonline" style="display:none">
				<button id="button_reset">RESET</button>
			</div>
		</div>

	</main>


	<script type="importmap">
		{
      "imports": {
        "three": "../build/three.module.js"
      }
    }
  </script>

	<script type="module">
		import * as THREE from 'three';
		import { OrbitControls } from '//cdn.skypack.dev/three@0.136/examples/jsm/controls/OrbitControls.js';
    import { Reflector } from '//cdn.skypack.dev/three@0.136/examples/jsm/objects/Reflector.js';

		const VIDEO_SOURCES = {
			'fire': ["textures/dunhuang/SKELETON/ChineseDance_Particle_Fire.mp4", "textures/dunhuang/SKELETON/ChineseDance_Particle_Water.mp4"],
			'water': ["textures/dunhuang/SKELETON/ChineseDance_Particle_Water.mp4"],
			'spin_particles': ["textures/dunhuang/SKELETON/Spin_Particles.mp4"],
			'gold_lines': ["textures/dunhuang/SKELETON/DanceTurn_Lines_Gold_Fast.mp4"],
			'spin_strips': ["textures/dunhuang/SKELETON/Spin_Strips.mp4"],
			'mocap': []
		};

		for (let i=1; i<3;i++) {
			VIDEO_SOURCES.mocap.push("textures/dunhuang/OF/36pose-male-0" + i + "-front.mov");
		}

    const Settings = function() {
			this.currentVideo = 'fire';
			this.cameraX = 0;
			this.cameraY = 0;
			this.cameraZ = -30;
			this.groundWidth = 2000;
			this.groundHeight = 2000;
			this.showGridHelper = false;
			this.numVideoClonesX = 3;
			this.numVideoClonesZ = 6;
			this.videoSpacingX = 18;
			this.videoSpacingZ = 10;
			this.videoWidth = 12; //original video aspect ratio is 16
			this.videoHeight = 16;
			this.videoDepth = 0.001;
			this.videoOpacity = 0.3;
    };
    const settings = new Settings();

		let camera;
		let canvas; // dom element the renderer renders to
		let textures = [];
		let videoIdsActive = [];
		let videoDOMs = [];
		let objects = [];


		function createVideoSrcDOMs() {
			const videoSources = VIDEO_SOURCES[settings.currentVideo];
			console.log(settings.currentVideo, videoSources.length);

			videoSources.forEach((videoSrc, i) => {
				const video = document.createElement('video');
				video.id = 'video_' + settings.currentVideo + "_" + i;
				video.src = videoSrc;
				video.autoplay = true;
				video.muted = true;
				video.loop = true;
				video.playsinline = true;
				video.crossOrigin = 'anonymous';
				videoDOMs.push(video);
				console.log(video);
				document.body.appendChild(video);
			});
		}

		function init() {
			if (canvas) {
				canvas.remove();
			}

			createVideoSrcDOMs();

			const renderer = new THREE.WebGLRenderer();

			renderer.setSize(window.innerWidth, window.innerHeight);

			canvas = renderer.domElement;

			document.body.appendChild(renderer.domElement);

			const scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera(
					45,
					window.innerWidth / window.innerHeight,
					0.1,
					1000
			);

			const ambientLight = new THREE.AmbientLight( 0xcccccc, 0.4 );
				scene.add( ambientLight );

				const pointLight = new THREE.PointLight( 0xffffff, 0.8 );
				camera.add( pointLight );
				scene.add( camera );


			const orbit = new OrbitControls(camera, renderer.domElement);

			camera.position.set(settings.cameraX, settings.cameraY, settings.cameraZ);

			orbit.update();

			const groundGeometry = new THREE.PlaneGeometry(settings.groundWidth, settings.groundHeight);

			const planeMesh = new THREE.Mesh( groundGeometry,
					new THREE.MeshBasicMaterial({
							side: THREE.DoubleSide,
							visible: false
					})
			);
			planeMesh.rotateX(-Math.PI / 2);
			scene.add(planeMesh);
			planeMesh.name = 'ground';

			const groundMirror = new Reflector( groundGeometry, {
				clipBias: 0.001, //0.003
				textureWidth: window.innerWidth * window.devicePixelRatio,
				textureHeight: window.innerHeight * window.devicePixelRatio,
				color: 0x777777
			} );
			groundMirror.position.y = -settings.videoHeight / 2;
			groundMirror.rotateX( - Math.PI / 2 );
			scene.add( groundMirror );
			groundMirror.name = 'groundMirror';


			const skyMirror = new Reflector( groundGeometry, {
				clipBias: 0.003,
				textureWidth: window.innerWidth * window.devicePixelRatio,
				textureHeight: window.innerHeight * window.devicePixelRatio,
				color: 0x777777
			} );
			skyMirror.position.x = -20;
			skyMirror.position.y = settings.videoHeight / 2;
			skyMirror.rotateX( Math.PI / 2 );
			scene.add( skyMirror );
			skyMirror.name = 'skyMirror';

			if (settings.showGridHelper) {
				const grid = new THREE.GridHelper(settings.groundWidth, settings.groundHeight);
				scene.add(grid);
			}


			function createVideoMesh(videoId) {
				const video = document.getElementById( videoId );
				video.play(); // this is the key to play video
				const texture = new THREE.VideoTexture( video );
				texture.minFilter = THREE.LinearFilter;
				texture.magFilter = THREE.LinearFilter;
				texture.repeat.set(0.5, 1); // this scales the video
				const geometry = new THREE.BoxGeometry(settings.videoWidth, settings.videoHeight, settings.videoDepth);
				const material = new THREE.MeshBasicMaterial({
					map: texture,
					side: THREE.FrontSide,
					toneMapped: false,
					transparent: true,
					opacity: settings.videoOpacity
				});

				if (videoIdsActive.indexOf(videoId) === -1) {
					videoIdsActive.push(videoId);
					textures.push(texture);
				}

				return new THREE.Mesh(geometry, material);
			}


			function createVideoMeshAt(x, y, z, meshToClone) {
				const videoIdx = 0;
				let meshClone = meshToClone ? meshToClone.clone() : createVideoMesh('video_' + settings.currentVideo + '_' + videoIdx);
				meshClone.position.set(x, y, z);
				scene.add(meshClone);
				objects.push(meshClone);
			}

		//	const mesh = createVideoMesh('video_' + settings.currentVideo + "_" + 0);

			// FIRST ROW
			for (var i = 0 ; i < settings.numVideoClonesX; i++) {
				createVideoMeshAt(i*settings.videoSpacingX, 0, 0);
			}

			for (var i = 0 ; i < settings.numVideoClonesX; i++) {
				createVideoMeshAt(-i*settings.videoSpacingX, 0, 0);
			}


			//

			for (var i = 0 ; i < settings.numVideoClonesZ; i++) {
				createVideoMeshAt(0, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(settings.videoSpacingX, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(-settings.videoSpacingX, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(settings.videoSpacingX*settings.numVideoClonesX, 0, i*settings.videoSpacingZ);
			}

			for (var i = 0 ; i <settings.numVideoClonesZ; i++) {
				createVideoMeshAt(-settings.videoSpacingX*settings.numVideoClonesX, 0, i*settings.videoSpacingZ);
			}

			// const mousePosition = new THREE.Vector2();

			function animate(time) {
				textures.forEach((texture, i) => {
						texture.needsUpdate = true; // this is the key to play the video
				});
				renderer.render(scene, camera);
			}

			renderer.setAnimationLoop(animate);
		}

		init();


		function onButtonClick(clickEvent) {
				$('#button_' + settings.currentVideo).removeClass( "active" );
				const buttonId = clickEvent.target.id;
				$('#'+buttonId).addClass( "active" );
				const currentVideo = buttonId.split("button_")[1];
				settings.currentVideo = currentVideo;

				videoIdsActive = [];
				textures = [];
				objects = [];

				videoDOMs.forEach(videoDOM => videoDOM.remove());
				videoDOMs = [];
				init();
		}

		$('#button_reset').click(  function () {
			camera.position.set(settings.cameraX, settings.cameraY, settings.cameraZ);
			camera.lookAt(0,0,0);
		} );

		$('#button_fire').click(  function () {
			onButtonClick(event);
		} );

		$('#button_water').click(  function () {
			onButtonClick(event);
		} );

		$('#button_spin_particles').click(  function () {
			onButtonClick(event);
		} );

		$('#button_spin_strips').click(  function () {
			onButtonClick(event);
		} );

		$('#button_mocap').click(  function () {
			onButtonClick(event);
		} );

		window.addEventListener('resize', function() {
		    camera.aspect = window.innerWidth / window.innerHeight;
		    camera.updateProjectionMatrix();
		    renderer.setSize(window.innerWidth, window.innerHeight);
		});

  </script>
</body>
